server {
    set_by_lua $WWWROOT_DIR 'return os.getenv("WWWROOT_DIR")';
    server_name test.xiaoshuo.io;

    index index.html index.php;
    root $WWWROOT_DIR/xiaoshuo.io;

    charset gbk;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;

    # if ( $host != 'xiaoshuo.io' ){
    #     rewrite ^/(.*)$ https://xiaoshuo.io/$1 permanent;
    # }

    #1后台（如果改了后台文件夹名称，这个位置也要改为新名称）
    rewrite ^(.*)/(admin)/$             $1/$2/index.php last;

    #2首页
    rewrite ^(.*)/index\.html$      $1/index.php last;

    #3板块页面
    rewrite ^(.*)/(category|chapter|article|author|so|txt|wap|wap_speed|wap_touch)/$                $1/$2/index.php last;
    #4功能页面（不可改名）
    rewrite ^(.*)/(cj|locoy|login|make|MyAdmin|login)/$ $1/$2/index.php last;
    #5其它一些页面
    rewrite ^(.*)/(member|paihang|shuku|quanben|tuijian)/$                                          $1/$2/index.php last;

    #6书库、推荐、作者
    rewrite ^(.*)/(shuku|quanben|tuijian|author)/([0-9]+)\.html$        $1/$2/index.php?$3.html last;
    #7全本、推荐（栏目）
    rewrite ^(.*)/(shuku|quanben|tuijian)/([0-9]+)-([0-9]+)\.html$      $1/$2/index.php?$3-$4.html last;
    #8排行榜
    rewrite ^(.*)/paihang/(.*)-([0-9]+)\.html$                          $1/paihang/index.php?$2-$3.html last;

    #9内容页(拼音)
    rewrite ^(.*)/(\w+)/([0-9]+)\.html$                                 $1/article/index.php?$3.html last;
    #10目录页(拼音)
    rewrite ^(.*)/(\w+)/list\.html$                                     $1/chapter/index.php?$2.html last;
    #11书页(拼音)
    rewrite ^(.*)/(\w+)/$                                               $1/page/index.php?$2.html last;
    #1213栏目页(拼音)
    rewrite ^(.*)/(\w+)\.html$                                          $1/category/index.php?$2.html last;
    rewrite ^(.*)/(\w+)/([0-9]+)-([0-9]+)\.html$                        $1/category/index.php?$3-$4.html last;

    #14禁止直接访问模版
    rewrite ^(.*)/templets/(.*)/(.*)\.htm$                              $1/404.html last;

    location ~ \.php$ {
        fastcgi_pass   xiaoshuo-php:9000;
        fastcgi_index  index.php;
        fastcgi_param   SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;
        include        fastcgi_params;
    }
}

server {
    set_by_lua $WWWROOT_DIR 'return os.getenv("WWWROOT_DIR")';
    server_name m-test.xiaoshuo.io;

    index index.html index.php;
    root $WWWROOT_DIR/xiaoshuo.io;

    charset gbk;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;


    #1板块页面
    rewrite ^(.*)/(category|chapter|article|author|so)/$                $1/wap/$2/index.php last;
    #2其它一些页面
    rewrite ^(.*)/(paihang|shuku|quanben)/$                             $1/wap/$2/index.php last;

    #3书库、全本
    rewrite ^(.*)/(shuku|quanben)/([0-9]+)\.html$                       $1/wap/$2/index.php?$3.html last;
    #45排行榜、作者页、搜索页
    rewrite ^(.*)/(paihang|author|so)/(.*)\.html$                       $1/wap/$2/index.php?$3.html last;
    rewrite ^(.*)/(paihang|author|so)/(.*)-([0-9]+)\.html$              $1/wap/$2/index.php?$3-$4.html last;

    #6目录页(拼音)
    rewrite ^(.*)/(\w+)/list/([0-9]+)\.html$                        $1/wap/chapter/index.php?$2-$3.html last;
    #7内容页(拼音)
    rewrite ^(.*)/(\w+)/([0-9]+)\.html$                             $1/wap/article/index.php?$3.html last;

    #89栏目页(拼音)
    rewrite ^(.*)/(\w+)\.html$                                      $1/wap/category/index.php?$2.html last;
    rewrite ^(.*)/(\w+)/([0-9]+)-([0-9]+)\.html$                    $1/wap/category/index.php?$3-$4.html last;
    #10书页(拼音)
    rewrite ^(.*)/(\w+)/$                                           $1/wap/page/index.php?$2.html last;

    #11禁止直接访问模版
    rewrite ^(.*)/templets/(.*)\.html$                              $1/wap/404.html last;

    location ~ \.php$ {
        fastcgi_pass   xiaoshuo-php:9000;
        fastcgi_index  index.php;
        fastcgi_param   SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;
        include        fastcgi_params;
    }
}

server {
    server_name *.xiaoshuo.io xiaoshuo.io;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;

    location / {
        return 403;
    }
}

server {
    listen       80;
    server_name xiaoshuo.io *.xiaoshuo.io;

    location / {
        add_header strict-transport-security 'max-age=31536000; includeSubDomains; preload';
        rewrite ^(.*) https://$host$request_uri permanent;
    }
}