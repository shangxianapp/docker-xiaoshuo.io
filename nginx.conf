server {
    set_by_lua $WWWROOT_DIR 'return os.getenv("WWWROOT_DIR")';
    server_name xiaoshuo.io www.xiaoshuo.io test.xiaoshuo.io;

    root $WWWROOT_DIR/xiaoshuo.io;

    charset gbk;

    # 编码
    brotli_static on;
    gzip_static on;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;

    error_page 403 404 500 @404;
    location @404 {
        rewrite ^(.*)$ /404.html last;
    }

    include inc/sts.conf;
    include inc/security.conf;
    include vhost/xiaoshuo.io/cache-small.conf;

    if ( $host != 'xiaoshuo.io' ){
        rewrite ^/(.*)$ https://xiaoshuo.io/$1 permanent;
    }

    sub_filter_last_modified    on;
    sub_filter 'http://www.zwdu.com' 'https://www.zwdu.com';
    sub_filter_once off;

    #1后台（如果改了后台文件夹名称，这个位置也要改为新名称）
    rewrite ^/admin/$                                                   /admin/index.php last;

    #2首页
    rewrite ^/$                                                         /index.php last;

    #3板块页面
    rewrite ^/(category|chapter|article|author|so)/$                    /$1/index.php last;
    #4功能页面（不可改名）
    rewrite ^/(cj|MyAdmin)/$                                            /$1/index.php last;
    #5其它一些页面
    rewrite ^/(member|paihang|shuku|quanben|tuijian)/$                  /$1/index.php last;

    #6书库、推荐、作者
    rewrite ^/(shuku|quanben|tuijian|author)/([0-9]+)\.html$            /$1/index.php?$2.html last;
    #7全本、推荐（栏目）
    rewrite ^/(shuku|quanben|tuijian)/([0-9]+)-([0-9]+)\.html$          /$1/index.php?$2-$3.html last;
    #8排行榜
    rewrite ^/paihang/(.*)-([0-9]+)\.html$                              /paihang/index.php?$1-$2.html last;

    #9内容页(拼音)
    rewrite ^/(\w+)/([0-9]+)\.html$                                     /article/index.php?$2.html last;
    #10目录页(拼音)
    rewrite ^/(\w+)/list\.html$                                         /chapter/index.php?$1.html last;
    #11书页(拼音)
    rewrite ^/(\w+)/$                                                   /page/index.php?$1.html last;
    #1213栏目页(拼音)
    rewrite ^/(\w+)\.html$                                              /category/index.php?$1.html last;
    rewrite ^/(\w+)/([0-9]+)-([0-9]+)\.html$                            /category/index.php?$2-$3.html last;

    #14禁止直接访问模版
    location ~* ^/templets/tpl/(.+)\.(htm|html|kuozhanmingyaochangdian)$ {
        return 404;
    }

    # 支持 jpg,png -> webp
    location ~* \.(jpg|png|meibanfawojiuxiangchangdianyirangquanzhongdadian)$ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;

        if ($cookie_webp = '1') {
            rewrite ^/(.*)$ /$1.webp last;
        }
    }
    location ~* \.webp$ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        try_files $uri $uri/ @webp;
    }
    location @webp {
        content_by_lua_file 'lua/webp.lua';
    }

    location ~ \.php$ {
        client_max_body_size 50M;
        fastcgi_buffers 8 1600k;
        fastcgi_buffer_size 3200k;
        fastcgi_connect_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_read_timeout 300s;
        fastcgi_pass   xiaoshuo-php:9000;
        fastcgi_index  index.php;
        fastcgi_param   SCRIPT_FILENAME  /var/www/html/$fastcgi_script_name;
        include        fastcgi_params;
    }

    # 静态文件最大缓存
    location ~* ^/(uploads|templets\/tpl)/ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
    }

    location ^~ /templets/tpl/js/ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        concat on;
        concat_types application/javascript;
        concat_max_files 30;
        default_type application/javascript;
    }

    location ^~ /templets/tpl/css/ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        concat on;
        concat_types text/css;
        concat_max_files 30;
        default_type text/css;
    }
}

server {
    set_by_lua $WWWROOT_DIR 'return os.getenv("WWWROOT_DIR")';
    server_name m.xiaoshuo.io;

    index index.html index.php;
    root $WWWROOT_DIR/xiaoshuo.io/wap;

    charset gbk;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;

    error_page 403 404 500 @404;
    location @404 {
        rewrite ^(.*)$ /404.html last;
    }

    include inc/sts.conf;
    include inc/security.conf;
    include vhost/xiaoshuo.io/cache-small.conf;

    # 屏蔽后台
    location /admin/ {
        return 404;
    }

    sub_filter_last_modified    on;
    sub_filter 'http://www.zwdu.com' 'https://www.zwdu.com';
    sub_filter_once off;

    # 书库、全本、排行
    rewrite ^/(shuku|quanben)/$                                         /$1/index.php last;
    rewrite ^/(shuku|quanben)/([0-9]+)\.html$                           /$1/index.php?$2.html last;
    rewrite ^/paihang/$                                                 /paihang/index.php?click-1.html last;
    rewrite ^/paihang/([0-9]+)\.html$                                   /paihang/index.php?click-$1.html last;

    # 分类
    rewrite ^/all/$                                                     /index.php?all.html last;

    #1板块页面
    rewrite ^/(category|chapter|article|author|so)/$                    /$1/index.php last;

    #3书库、全本
    rewrite ^/(shuku)/([0-9]+)\.html$                                   /$1/index.php?$2.html last;
    #45排行榜、作者页、搜索页
    rewrite ^/(author|so)/(.*)\.html$                                   /$1/index.php?$2.html last;
    rewrite ^/(author|so)/(.*)-([0-9]+)\.html$                          /$1/index.php?$2-$3.html last;

    #6目录页(拼音)
    rewrite ^/(\w+)/list/([0-9]+)\.html$                                /chapter/index.php?$1-$2.html last;
    #7内容页(拼音)
    rewrite ^/(\w+)/([0-9]+)\.html$                                     /article/index.php?$2.html last;

    #89栏目页(拼音)
    rewrite ^/(\w+)\.html$                                              /category/index.php?$1.html last;
    rewrite ^/(\w+)/([0-9]+)-([0-9]+)\.html$                            /category/index.php?$2-$3.html last;
    #10书页(拼音)
    rewrite ^/(\w+)/$                                                   /page/index.php?$1.html last;

    #11禁止直接访问模版
    location ~* ^/templets/(.+)\.html$ {
        return 404;
    }

    # 支持 jpg,png -> webp
    location ~* \.(jpg|png|meibanfawojiuxiangchangdianyirangquanzhongdadian)$ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;

        if ($cookie_webp = '1') {
            rewrite ^/(.*)$ /$1.webp last;
        }
    }
    location ~* \.webp$ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        try_files $uri $uri/ @webp;
    }
    location @webp {
        content_by_lua_file 'lua/webp.lua';
    }

    location /style/js/ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        concat on;
        concat_types application/javascript;
        concat_max_files 30;
        default_type application/javascript;
    }

    location /style/css/ {
        include inc/sts.conf;
        include inc/security.conf;
        include vhost/xiaoshuo.io/cache-max.conf;
        concat on;
        concat_types text/css;
        concat_max_files 30;
        default_type text/css;
    }

    location ~ \.php$ {
        client_max_body_size 50M;
        fastcgi_buffers 8 1600k;
        fastcgi_buffer_size 3200k;
        fastcgi_connect_timeout 300s;
        fastcgi_send_timeout 300s;
        fastcgi_read_timeout 300s;
        fastcgi_pass   xiaoshuo-php:9000;
        fastcgi_index  index.php;
        fastcgi_param   SCRIPT_FILENAME  /var/www/html/wap/$fastcgi_script_name;
        include        fastcgi_params;
    }
}

server {
    server_name *.xiaoshuo.io xiaoshuo.io;

    include                         inc/ssl.conf;
    ssl_certificate                 ca/xiaoshuo.io/fullchain.cer;
    ssl_certificate_key             ca/xiaoshuo.io/xiaoshuo.io.key;

    location / {
        return 403;
    }
}

server {
    listen       80;
    server_name xiaoshuo.io *.xiaoshuo.io;

    location / {
        add_header strict-transport-security 'max-age=31536000; includeSubDomains; preload';
        rewrite ^(.*) https://$host$request_uri permanent;
    }
}